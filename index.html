<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('id');
        const size = parseInt(urlParams.get('size') || '64');

        if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
            // Return error image as actual PNG
            drawAndServeImage('ERR', '#ff4444');
        } else {
            generateAndServeThumbnail(videoId, size);
        }

        function generateAndServeThumbnail(videoId, size) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            const qualities = ['maxresdefault', 'sddefault', 'hqdefault', 'mqdefault'];
            let currentQuality = 0;

            function tryNextQuality() {
                if (currentQuality >= qualities.length) {
                    drawAndServeImage('YT', generateColor(videoId));
                    return;
                }

                const quality = qualities[currentQuality];
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function () {
                    // Crop to square
                    const sourceSize = Math.min(img.width, img.height);
                    const sx = (img.width - sourceSize) / 2;
                    const sy = (img.height - sourceSize) / 2;

                    // Draw cropped and resized
                    ctx.drawImage(img, sx, sy, sourceSize, sourceSize, 0, 0, size, size);

                    // Serve the image
                    serveCanvasImage(canvas);
                };

                img.onerror = function () {
                    currentQuality++;
                    tryNextQuality();
                };

                img.src = `https://i.ytimg.com/vi/${videoId}/${quality}.jpg?t=${Date.now()}`;
            }

            tryNextQuality();
        }

        function generateColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        function drawAndServeImage(text, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 64, 64);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 32, 32);

            serveCanvasImage(canvas);
        }

        function serveCanvasImage(canvas) {
            // Convert canvas to data URL
            const dataUrl = canvas.toDataURL('image/png');

            // Redirect to the data URL
            window.location.href = dataUrl;
        }
    </script>
</head>

<body>
    <!-- Page will redirect to the actual image data URL -->
    <p>Generating thumbnail...</p>
</body>

</html>